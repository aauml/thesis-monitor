<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Thesis Monitor — EU AI Act ↔ NIST AI RMF</title>
<style>
  /* ── Reset & base ── */
  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    background: #FAFAF8;
    color: #111;
    min-height: 100vh;
  }
  a { color: #1E40AF; text-decoration: none; }
  a:hover { text-decoration: underline; }
  button { font-family: inherit; cursor: pointer; }

  /* ── Layout ── */
  .container { max-width: 760px; margin: 0 auto; padding: 0 24px; }

  /* ── Header ── */
  header {
    border-bottom: 2px solid #111;
    padding: 32px 0 20px;
    margin-bottom: 0;
  }
  .header-top {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 4px;
  }
  h1 {
    font-family: Georgia, serif;
    font-size: 34px;
    font-weight: 300;
    letter-spacing: -0.5px;
  }
  .header-sub {
    font-family: Georgia, serif;
    font-size: 14px;
    color: #6B7280;
    font-style: italic;
    margin-bottom: 16px;
  }
  .header-stats {
    display: flex;
    gap: 20px;
    font-size: 13px;
    color: #6B7280;
    flex-wrap: wrap;
  }
  .header-stats strong { color: #111; }
  .refresh-area { display: flex; gap: 14px; align-items: baseline; }
  .last-fetch { font-size: 11px; color: #9CA3AF; }
  .btn-refresh {
    font-size: 12px; font-weight: 600;
    color: #1E40AF; background: none; border: none;
    padding: 0;
  }
  .btn-refresh:disabled { color: #9CA3AF; cursor: default; }

  /* ── Filters ── */
  .filters {
    padding: 14px 0 0;
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    align-items: center;
  }
  .filters input[type=text] {
    flex: 1; min-width: 180px;
    padding: 7px 11px; font-size: 13px;
    border: 1px solid #E5E7EB; border-radius: 4px;
    background: #fff; outline: none;
    font-family: inherit;
  }
  .filters input[type=text]:focus { border-color: #93C5FD; }
  .btn-imp {
    padding: 5px 11px; font-size: 11px; font-weight: 600;
    letter-spacing: 0.04em; text-transform: uppercase;
    border: 1px solid #E5E7EB; border-radius: 4px;
    background: #fff; color: #6B7280;
    transition: all 0.1s;
  }
  .btn-imp.active-ALTA  { background: #DC2626; border-color: #DC2626; color: #fff; }
  .btn-imp.active-MEDIA { background: #D97706; border-color: #D97706; color: #fff; }
  .btn-imp.active-BAJA  { background: #9CA3AF; border-color: #9CA3AF; color: #fff; }
  select {
    padding: 6px 8px; font-size: 12px;
    border: 1px solid #E5E7EB; border-radius: 4px;
    background: #fff; color: #374151;
    font-family: inherit; cursor: pointer;
  }
  .btn-search {
    padding: 6px 14px; font-size: 13px; font-weight: 500;
    border: 1px solid #1E40AF; border-radius: 4px;
    background: #1E40AF; color: #fff; font-family: inherit;
  }
  .btn-search:hover { background: #1e3a8a; border-color: #1e3a8a; }
    font-size: 12px; color: #9CA3AF;
    background: none; border: none; padding: 0;
  }
  .filter-count { font-size: 12px; color: #9CA3AF; padding: 4px 0 0; }

  /* ── Cards ── */
  main { padding: 0 0 80px; }
  article {
    border-bottom: 1px solid #E5E7EB;
    padding: 22px 0;
    cursor: pointer;
  }
  article:hover { background: #FAFAFA; margin: 0 -8px; padding-left: 8px; padding-right: 8px; }
  .card-meta { display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap; }
  .badge {
    display: inline-block;
    padding: 2px 10px; border-radius: 3px;
    font-size: 11px; font-weight: 600;
    letter-spacing: 0.04em; text-transform: uppercase;
    line-height: 1.6;
  }
  .badge-small { padding: 1px 6px; font-size: 10px; border: 1px solid transparent; }
  .badge-imp-ALTA  { background: #DC2626; color: #fff; }
  .badge-imp-MEDIA { background: #D97706; color: #fff; }
  .badge-imp-BAJA  { background: #9CA3AF; color: #fff; }
  .badge-Teorica,
  .badge-Teórica   { background: #EFF6FF; color: #1E40AF; border-color: #BFDBFE !important; }
  .badge-Analitica,
  .badge-Analítica { background: #F0FDF4; color: #166534; border-color: #BBF7D0 !important; }
  .badge-Evaluativa { background: #FAF5FF; color: #6B21A8; border-color: #E9D5FF !important; }
  .action-tag { font-size: 11px; font-weight: 700; letter-spacing: 0.05em; }
  .action-REFERENCE { color: #1E40AF; }
  .action-CONTEXT   { color: #6B7280; }
  .action-FOLLOW-UP { color: #D97706; }
  .action-URGENT    { color: #DC2626; }
  .content-type { font-size: 11px; color: #9CA3AF; text-transform: uppercase; letter-spacing: 0.05em; }
  .card-title {
    font-family: Georgia, serif;
    font-size: 19px; font-weight: 400; line-height: 1.35;
    margin: 0 0 5px; color: #111;
  }
  .card-byline {
    display: flex; gap: 10px; align-items: center;
    font-size: 13px; color: #9CA3AF; flex-wrap: wrap;
  }
  .card-byline .scholar { color: #6B7280; font-weight: 500; }
  .card-byline .lang { text-transform: uppercase; font-weight: 600; font-size: 11px; }
  .card-body {
    margin-top: 14px;
    padding-left: 14px;
    border-left: 2px solid #E5E7EB;
    display: none;
  }
  .card-body.open { display: block; }
  .card-body p {
    font-size: 14px; line-height: 1.7;
    margin: 0 0 10px; color: #4B5563;
  }
  .card-body p.thesis { color: #111; font-weight: 500; }
  .card-body .read-link { font-size: 13px; font-weight: 500; }

  /* ── Pagination ── */
  .pagination {
    display: flex; gap: 8px;
    justify-content: center;
    padding: 32px 0 0;
    align-items: center;
    flex-wrap: wrap;
  }
  .btn-page {
    padding: 7px 12px; font-size: 13px;
    border: 1px solid #E5E7EB; border-radius: 4px;
    background: #fff; color: #374151;
  }
  .btn-page:hover:not(:disabled) { border-color: #93C5FD; }
  .btn-page.current { background: #1E40AF; border-color: #1E40AF; color: #fff; font-weight: 600; cursor: default; }
  .btn-page:disabled { color: #D1D5DB; background: #F9FAFB; cursor: default; }
  .btn-page-nav { padding: 7px 16px; }
  .ellipsis { font-size: 13px; color: #9CA3AF; padding: 0 4px; }

  /* ── States ── */
  .state-msg { text-align: center; padding: 60px 0; color: #9CA3AF; font-size: 14px; }
  .error-box {
    margin-top: 24px; padding: 14px 16px;
    background: #FEF2F2; border: 1px solid #FECACA;
    border-radius: 6px; font-size: 13px; color: #991B1B;
    line-height: 1.6;
  }
  .error-box strong { display: block; margin-bottom: 4px; }

  /* ── Export ── */
  .export-bar {
    padding: 10px 0 0;
    display: flex; gap: 10px; align-items: center;
  }
  .btn-export {
    font-size: 11px; color: #6B7280; background: none;
    border: 1px solid #E5E7EB; border-radius: 4px;
    padding: 4px 10px; font-family: inherit;
  }
  .btn-export:hover { border-color: #93C5FD; color: #1E40AF; }
</style>
</head>
<body>

<div class="container">

  <!-- Header -->
  <header>
    <div class="header-top">
      <h1>Thesis Monitor</h1>
      <div class="refresh-area">
        <span class="last-fetch" id="lastFetch"></span>
        <button class="btn-refresh" id="btnRefresh" onclick="refresh()">↻ Refresh</button>
      </div>
    </div>
    <p class="header-sub">EU AI Act ↔ NIST AI RMF Interoperability</p>
    <div class="header-stats" id="headerStats">
      <span>Loading…</span>
    </div>
  </header>

  <!-- Filters -->
  <div class="filters" id="filters">
    <input type="text" id="searchInput" placeholder="Search title, scholar, topic…" onkeydown="if(event.key==='Enter')submitSearch()" />
    <button class="btn-search" onclick="submitSearch()">Search</button>
    <button class="btn-imp" id="btn-ALTA"  onclick="toggleImp('ALTA')">Alta</button>
    <button class="btn-imp" id="btn-MEDIA" onclick="toggleImp('MEDIA')">Media</button>
    <button class="btn-imp" id="btn-BAJA"  onclick="toggleImp('BAJA')">Baja</button>
    <select id="selSort" onchange="applyFilters()">
      <option value="date-desc">Newest first</option>
      <option value="date-asc">Oldest first</option>
      <option value="importance">By importance</option>
    </select>
    <button class="btn-clear" id="btnClear" onclick="clearFilters()" style="display:none">Clear</button>
  </div>
  <div class="container"><p class="filter-count" id="filterCount"></p></div>

  <!-- Export -->
  <div class="export-bar">
    <button class="btn-export" onclick="exportMarkdown()">⬇ Copy as Markdown</button>
  </div>

  <!-- Main content -->
  <main id="main">
    <div class="state-msg">Loading…</div>
  </main>

  <!-- Pagination -->
  <div class="pagination" id="pagination"></div>

</div><!-- /container -->

<script>
// ── Config ──────────────────────────────────────────────────
const API_URL = "https://script.google.com/macros/s/AKfycbzk2vhu-qcKFBPqEImKGEZKSitpVZv1IQQEv5ZzG7pNfo-iPUWfvSoLWWnkoc8d8PQQ/exec";
const LIMIT   = 50;

// ── State ───────────────────────────────────────────────────
let state = {
  page: 1, total: 0, total_pages: 1, has_next: false, has_prev: false,
  importance: "", capa: "", action_tag: "", language: "", sort: "date-desc", search: "",
  rows: [], loading: false, lastFetch: null,
};
let expandedIds = new Set();

// ── JSONP ────────────────────────────────────────────────────
function jsonp(url) {
  return new Promise((resolve, reject) => {
    const cbName = "_cb_" + Math.random().toString(36).slice(2);
    const timer = setTimeout(() => { delete window[cbName]; reject(new Error("Request timed out")); }, 25000);
    window[cbName] = (data) => { clearTimeout(timer); delete window[cbName]; resolve(data); };
    const s = document.createElement("script");
    s.src = url + (url.includes("?") ? "&" : "?") + "callback=" + cbName;
    s.onerror = () => { clearTimeout(timer); delete window[cbName]; reject(new Error("Network error — check your internet connection")); };
    document.head.appendChild(s);
  });
}

function buildUrl() {
  let url = API_URL + "?action=getPage";
  const p = {
    page: state.page, limit: LIMIT, sort: state.sort,
    importance: state.importance, capa: state.capa,
    action_tag: state.action_tag, language: state.language,
    search: state.search,
  };
  for (const [k, v] of Object.entries(p)) {
    if (v !== "" && v != null) url += "&" + encodeURIComponent(k) + "=" + encodeURIComponent(v);
  }
  return url;
}

// ── Fetch ────────────────────────────────────────────────────
async function fetchPage() {
  if (state.loading) return;
  state.loading = true;
  expandedIds.clear();
  setRefreshBtn(true);
  renderMain('<div class="state-msg">Loading…</div>');
  renderPagination();

  try {
    const data = await jsonp(buildUrl());
    if (data.error) throw new Error(data.error);
    state.rows        = data.rows || [];
    state.total       = data.total;
    state.total_pages = data.total_pages;
    state.has_next    = data.has_next;
    state.has_prev    = data.has_prev;
    state.page        = data.page;
    state.lastFetch   = new Date();
    renderAll();
  } catch (e) {
    renderMain(`<div class="error-box"><strong>Could not load data.</strong>${e.message}</div>`);
  }

  state.loading = false;
  setRefreshBtn(false);
}

// ── Filter actions ───────────────────────────────────────────
function applyFilters() {
  state.page       = 1;
  state.importance = document.getElementById("btn-ALTA").classList.contains("active-ALTA") ? "ALTA"
                   : document.getElementById("btn-MEDIA").classList.contains("active-MEDIA") ? "MEDIA"
                   : document.getElementById("btn-BAJA").classList.contains("active-BAJA") ? "BAJA" : "";
  state.sort       = document.getElementById("selSort").value;
  // search is set independently by submitSearch — don't overwrite it here
  updateClearBtn();
  fetchPage();
}

function submitSearch() {
  state.search = document.getElementById("searchInput").value.trim();
  state.page = 1;
  updateClearBtn();
  fetchPage();
}

function toggleImp(imp) {
  ["ALTA","MEDIA","BAJA"].forEach(i => {
    const btn = document.getElementById("btn-" + i);
    btn.className = "btn-imp" + (i === imp && !btn.classList.contains("active-" + i) ? " active-" + i : "");
  });
  applyFilters();
}

function clearFilters() {
  document.getElementById("searchInput").value = "";
  document.getElementById("selSort").value = "date-desc";
  ["ALTA","MEDIA","BAJA"].forEach(i => document.getElementById("btn-" + i).className = "btn-imp");
  state.importance = ""; state.capa = ""; state.action_tag = "";
  state.language = ""; state.sort = "date-desc"; state.search = "";
  state.page = 1;
  updateClearBtn();
  fetchPage();
}

function updateClearBtn() {
  const has = state.importance || state.search;
  document.getElementById("btnClear").style.display = has ? "inline" : "none";
}

function refresh() { fetchPage(); }

function goPage(p) { state.page = p; fetchPage(); }

// ── Render ───────────────────────────────────────────────────
function renderAll() {
  renderHeader();
  renderMain(renderCards());
  renderPagination();
}

function renderHeader() {
  const el = document.getElementById("headerStats");
  const isFiltered = state.importance || state.capa || state.action_tag || state.language || state.search;
  el.innerHTML = `
    <span><strong>${state.total}</strong> ${isFiltered ? "matching" : "total"}</span>
    <span>page <strong>${state.page}</strong> of <strong>${state.total_pages}</strong></span>
    <span>${LIMIT} per page</span>
  `;
  if (state.lastFetch) {
    document.getElementById("lastFetch").textContent =
      state.lastFetch.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
  }
  const count = document.getElementById("filterCount");
  count.textContent = isFiltered && state.total_pages > 1
    ? `Showing ${((state.page-1)*LIMIT)+1}–${Math.min(state.page*LIMIT, state.total)} of ${state.total}` : "";
}

function impBadge(imp) {
  const labels = { ALTA: "Alta", MEDIA: "Media", BAJA: "Baja" };
  return `<span class="badge badge-imp-${imp}">${labels[imp] || imp}</span>`;
}

function capaBadges(capa) {
  return (capa || "").split(",").map(c => {
    c = c.trim();
    if (!c) return "";
    const cls = c.replace(/[áéíóú]/g, m => ({á:"a",é:"e",í:"i",ó:"o",ú:"u"}[m]));
    return `<span class="badge badge-small badge-${cls}">${c}</span>`;
  }).join(" ");
}

const ACTION_SYM = { REFERENCE: "◆", CONTEXT: "○", "FOLLOW-UP": "→", URGENT: "!" };

function formatDate(d) {
  if (!d) return "";
  const dt = new Date(d);
  if (isNaN(dt)) return String(d);
  return dt.toLocaleDateString("en-US", { year: "numeric", month: "short", day: "numeric" });
}

function renderCards() {
  if (!state.rows.length) return '<div class="state-msg">No results match your filters.</div>';
  return state.rows.map((item, idx) => {
    const id    = "card-" + state.page + "-" + idx;
    const imp   = item.importance || "BAJA";
    const act   = item.action_tag || "CONTEXT";
    const sym   = ACTION_SYM[act] || "○";
    const paras = (item.thesis_relevance || "").split(/\n\n|\n/).filter(p => p.trim());
    const isOpen = expandedIds.has(id);

    const byline = [
      item.source,
      item.date_published ? "· " + formatDate(item.date_published) : "",
      item.scholar ? `· <span class="scholar">${item.scholar}</span>` : "",
      item.language && item.language !== "en" ? `· <span class="lang">${item.language}</span>` : "",
    ].filter(Boolean).join(" ");

    const bodyParas = paras.map((p, i) => {
      const cls = i === paras.length - 1 ? " thesis" : "";
      return `<p class="${cls}">${p}</p>`;
    }).join("");

    const link = item.url
      ? `<a class="read-link" href="${item.url}" target="_blank" rel="noopener" onclick="event.stopPropagation()">Read source →</a>`
      : "";

    return `
      <article onclick="toggleCard('${id}')">
        <div class="card-meta">
          ${impBadge(imp)}
          ${capaBadges(item.capa)}
          <span class="action-tag action-${act}">${sym} ${act}</span>
          ${item.content_type ? `<span class="content-type">${item.content_type}</span>` : ""}
        </div>
        <h2 class="card-title">${item.title || "(no title)"}</h2>
        <div class="card-byline">${byline}</div>
        <div class="card-body${isOpen ? " open" : ""}" id="${id}">
          ${bodyParas}
          ${link}
        </div>
      </article>`;
  }).join("");
}

function toggleCard(id) {
  const el = document.getElementById(id);
  if (!el) return;
  if (expandedIds.has(id)) { expandedIds.delete(id); el.classList.remove("open"); }
  else                     { expandedIds.add(id);    el.classList.add("open"); }
}

function renderMain(html) {
  document.getElementById("main").innerHTML = html;
}

function renderPagination() {
  const el = document.getElementById("pagination");
  if (state.total_pages <= 1) { el.innerHTML = ""; return; }

  const pages = [];
  for (let i = 1; i <= state.total_pages; i++) {
    if (i === 1 || i === state.total_pages || Math.abs(i - state.page) <= 2) pages.push(i);
  }

  let html = `<button class="btn-page btn-page-nav" ${!state.has_prev ? "disabled" : ""} onclick="goPage(${state.page-1})">← Prev</button>`;

  let last = 0;
  for (const p of pages) {
    if (last && p - last > 1) html += `<span class="ellipsis">…</span>`;
    const cur = p === state.page ? " current" : "";
    html += `<button class="btn-page${cur}" onclick="goPage(${p})">${p}</button>`;
    last = p;
  }

  html += `<button class="btn-page btn-page-nav" ${!state.has_next ? "disabled" : ""} onclick="goPage(${state.page+1})">Next →</button>`;
  el.innerHTML = html;
}

function setRefreshBtn(loading) {
  const btn = document.getElementById("btnRefresh");
  btn.textContent = loading ? "↻ Loading…" : "↻ Refresh";
  btn.disabled = loading;
}

// ── Export ───────────────────────────────────────────────────
function exportMarkdown() {
  if (!state.rows.length) { alert("Nothing to export."); return; }
  const lines = [`# Thesis Monitor Export`, `_${state.total} items — page ${state.page} of ${state.total_pages}_`, ``];
  for (const item of state.rows) {
    lines.push(`## ${item.title || "(no title)"}`);
    lines.push(`**${item.importance}** · ${item.source} · ${formatDate(item.date_published)}`);
    if (item.scholar) lines.push(`Scholar: ${item.scholar}`);
    if (item.capa) lines.push(`Capa: ${item.capa}`);
    if (item.action_tag) lines.push(`Action: ${item.action_tag}`);
    lines.push(``);
    if (item.thesis_relevance) lines.push(item.thesis_relevance);
    if (item.url) lines.push(`\n[Source](${item.url})`);
    lines.push(`\n---\n`);
  }
  const text = lines.join("\n");
  navigator.clipboard.writeText(text)
    .then(() => alert("Copied to clipboard ✓"))
    .catch(() => { const ta = document.createElement("textarea"); ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); document.body.removeChild(ta); alert("Copied ✓"); });
}

// ── Init ─────────────────────────────────────────────────────
fetchPage();
</script>
</body>
</html>
